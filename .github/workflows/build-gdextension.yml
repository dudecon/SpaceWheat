name: Build GDExtension for All Platforms

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'native/**'
      - '.github/workflows/build-gdextension.yml'
      - 'godot-cpp'
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
    paths:
      - 'native/**'
      - '.github/workflows/build-gdextension.yml'
      - 'godot-cpp'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config

      - name: Build godot-cpp (Linux)
        run: |
          cd godot-cpp
          scons platform=linux target=template_release -j$(nproc)

      - name: Copy godot-cpp library
        run: |
          mkdir -p native/lib
          cp godot-cpp/bin/libgodot-cpp.linux.template_release.x86_64.a native/lib/

      - name: Create platform directory
        run: mkdir -p native/bin/linux

      - name: Build SpaceWheat extension
        run: |
          cd native
          make -j$(nproc)
          mv bin/*.so bin/linux/

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v3
        with:
          name: linux-extension
          path: native/bin/linux/*.so

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install scons
        run: python -m pip install scons

      - name: Build godot-cpp (Windows)
        run: |
          cd godot-cpp
          scons platform=windows target=template_release -j4

      - name: Create platform directory
        run: mkdir -p native/bin/windows

      - name: Build SpaceWheat extension
        run: |
          cd native
          cl.exe /std:c++17 /EHsc /MD /O2 /I include /I include\godot_cpp /I include\gdextension /DWINDOWS_ENABLED /DGDEXTENSION /LD src\*.cpp ..\godot-cpp\bin\libgodot-cpp.windows.template_release.x86_64.lib /Fe:bin\windows\libquantummatrix.windows.template_release.x86_64.dll

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v3
        with:
          name: windows-extension
          path: native/bin/windows/*.dll

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install scons
        run: python -m pip install scons

      - name: Build godot-cpp (macOS)
        run: |
          cd godot-cpp
          scons platform=macos target=template_release arch=universal -j$(sysctl -n hw.logicalcpu)

      - name: Create platform directory
        run: mkdir -p native/bin/macos

      - name: Build SpaceWheat extension
        run: |
          cd native
          clang++ -std=c++17 -dynamiclib -O2 -arch x86_64 -arch arm64 \
            -I./include -I./include/godot_cpp -I./include/gdextension \
            -DMACOS_ENABLED -DGDEXTENSION \
            src/*.cpp \
            ../godot-cpp/bin/libgodot-cpp.macos.template_release.universal.a \
            -o bin/macos/libquantummatrix.macos.template_release.framework

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v3
        with:
          name: macos-extension
          path: native/bin/macos/*.framework

  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Emscripten
        uses: mymindstorm/setup-emsdk@v13
        with:
          version: 3.1.45

      - name: Build godot-cpp (Web)
        run: |
          cd godot-cpp
          scons platform=web target=template_release -j$(nproc)

      - name: Create platform directory
        run: mkdir -p native/bin/web

      - name: Build SpaceWheat extension
        run: |
          cd native
          emcc -std=c++17 -O3 -s SIDE_MODULE=1 -s EXPORT_ALL=1 \
            -I./include -I./include/godot_cpp -I./include/gdextension \
            -DWEB_ENABLED -DGDEXTENSION \
            src/*.cpp \
            -o bin/web/libquantummatrix.wasm

      - name: Upload Web artifact
        uses: actions/upload-artifact@v3
        with:
          name: web-extension
          path: native/bin/web/*.wasm

  combine-artifacts:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, build-web]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Organize builds
        run: |
          mkdir -p builds/linux builds/windows builds/macos builds/web
          cp linux-extension/* builds/linux/ 2>/dev/null || true
          cp windows-extension/* builds/windows/ 2>/dev/null || true
          cp macos-extension/* builds/macos/ 2>/dev/null || true
          cp web-extension/* builds/web/ 2>/dev/null || true

      - name: Upload combined build
        uses: actions/upload-artifact@v3
        with:
          name: all-platforms
          path: builds/**

      - name: Package platform archives for release
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd builds
          tar czf ../spacewheat-native-linux-x86_64.tar.gz -C linux . 2>/dev/null || true
          zip -j ../spacewheat-native-windows-x86_64.zip windows/* 2>/dev/null || true
          tar czf ../spacewheat-native-macos-universal.tar.gz -C macos . 2>/dev/null || true
          tar czf ../spacewheat-native-web-wasm.tar.gz -C web . 2>/dev/null || true

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## Native C++ Extensions

            Pre-built native extensions for SpaceWheat quantum simulation engine.
            Download the archive for your platform and extract to `native/bin/{platform}/`.

            **Performance:** 10-100x faster quantum evolution vs GDScript fallback.

            ### Installation
            ```bash
            cd SpaceWheat
            # Example for Linux:
            tar xzf spacewheat-native-linux-x86_64.tar.gz -C native/bin/linux/
            # Example for Windows:
            unzip spacewheat-native-windows-x86_64.zip -d native/bin/windows/
            ```

            Then uncomment your platform in `quantum_matrix.gdextension`.
          files: |
            spacewheat-native-linux-x86_64.tar.gz
            spacewheat-native-windows-x86_64.zip
            spacewheat-native-macos-universal.tar.gz
            spacewheat-native-web-wasm.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
