name: Build GDExtension for All Platforms

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config

      - name: Build godot-cpp (Linux)
        run: |
          cd godot-cpp
          scons platform=linux target=template_release -j$(nproc)

      - name: Copy godot-cpp library
        run: |
          mkdir -p native/lib
          cp godot-cpp/bin/libgodot-cpp.linux.template_release.x86_64.a native/lib/

      - name: Build SpaceWheat extension
        run: |
          cd native
          make -j$(nproc)

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v3
        with:
          name: linux-extension
          path: native/bin/*.so

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install scons
        run: python -m pip install scons

      - name: Build godot-cpp (Windows)
        run: |
          cd godot-cpp
          scons platform=windows target=template_release -j4

      - name: Build SpaceWheat extension
        run: |
          cd native
          cl.exe /std:c++17 /EHsc /MD /O2 /I include /I include\godot_cpp /I include\gdextension /DWINDOWS_ENABLED /DGDEXTENSION /LD src\*.cpp ..\godot-cpp\bin\libgodot-cpp.windows.template_release.x86_64.lib /Fe:bin\libquantummatrix.windows.template_release.x86_64.dll

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v3
        with:
          name: windows-extension
          path: native/bin/*.dll

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install scons
        run: python -m pip install scons

      - name: Build godot-cpp (macOS)
        run: |
          cd godot-cpp
          scons platform=macos target=template_release arch=universal -j$(sysctl -n hw.logicalcpu)

      - name: Build SpaceWheat extension
        run: |
          cd native
          clang++ -std=c++17 -dynamiclib -O2 -arch x86_64 -arch arm64 \
            -I./include -I./include/godot_cpp -I./include/gdextension \
            -DMACOS_ENABLED -DGDEXTENSION \
            src/*.cpp \
            ../godot-cpp/bin/libgodot-cpp.macos.template_release.universal.a \
            -o bin/libquantummatrix.macos.template_release.framework

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v3
        with:
          name: macos-extension
          path: native/bin/*.framework

  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Emscripten
        uses: mymindstorm/setup-emsdk@v13
        with:
          version: 3.1.45

      - name: Build godot-cpp (Web)
        run: |
          cd godot-cpp
          scons platform=web target=template_release -j$(nproc)

      - name: Build SpaceWheat extension
        run: |
          cd native
          emcc -std=c++17 -O3 -s SIDE_MODULE=1 -s EXPORT_ALL=1 \
            -I./include -I./include/godot_cpp -I./include/gdextension \
            -DWEB_ENABLED -DGDEXTENSION \
            src/*.cpp \
            -o bin/libquantummatrix.wasm

      - name: Upload Web artifact
        uses: actions/upload-artifact@v3
        with:
          name: web-extension
          path: native/bin/*.wasm

  combine-artifacts:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, build-web]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Organize builds
        run: |
          mkdir -p builds
          cp linux-extension/* builds/
          cp windows-extension/* builds/
          cp macos-extension/* builds/
          cp web-extension/* builds/

      - name: Upload combined build
        uses: actions/upload-artifact@v3
        with:
          name: all-platforms
          path: builds/*

      - name: Create release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: builds/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
